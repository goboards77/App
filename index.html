<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>gpzip</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/tabulator-tables@5.5.0/dist/js/tabulator.min.js"></script>    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet">  
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono&display=swap" rel="stylesheet">
    <link href="https://unpkg.com/tabulator-tables@5.5.0/dist/css/tabulator.min.css" rel="stylesheet">
    <style>
        table { border-collapse: collapse; table-layout: auto; max-width: 900px; }
        th, td { border: 1px solid var(--text-color); text-align: right; white-space: nowrap; padding-left: 10px; padding-top: 5px; }
        th, td:first-child { text-align: left; }

        :root {
            --body-bg: #111827;      /* 900 */ 
            --card-bg: #18202f;      /* 850 */ 
            --text-color: #ffffff;   /* white */
            --hovclr: #185ec1;
        }

        body.light-mode {
            --body-bg: #d1d5db;      /* 300 */
            --card-bg: #ffffff;      /* white */
            --text-color: #000000;   /* black */
            --hovclr: #8299c8;
        }

        body { background-color: var(--body-bg); color: var(--text-color); }
        .card { background-color: var(--card-bg); }
        .btnDD:hover { background-color: var(--hovclr); }
    </style>
</head>
<body class="p-1" style="font-family: 'Roboto'; font-size: 18px;">
<button id="topBar"class="card w-full h-[50px] fixed top-0 left-0 z-50 text-lg text-left px-7" onclick="showCont('menuCont')">â˜° Start Here</button>
<div id="menuCont"class="hidden card w-full max-w-md mt-[50px] rounded-lg">
    <button class="btnDD" onclick="showEle(1,2,3)">ğŸ‘” Create</button>
    <button class="btnDD" onclick="showEle(11,12)">âœï¸ Alter</button>
    <button class="btnDD" onclick="showEle(21,22,23,24,25,26)">âœğŸ» Voucher</button>
    <button class="btnDD" onclick="showEle(31,32,33,34)">ğŸ‘€ Report</button>
    <button class="btnDD" onclick="switchTheme()">ğŸŒˆ Themes</button>
    <button class="btnDD" onclick="logout()">ğŸ” Logout</button>
</div>

<div id ="btnCont" class="hidden card max-w-md mt-[50px] p-2 rounded-lg">
    <button id=1 class="btnDD" onclick="showEle(101,102,103,104,1010)">Bhaduvat ğŸ§‘â€ğŸš’</button>
    <button id=2 class="btnDD" onclick="showEle(102,201,2010)">Monthly Vyaj Party ğŸ§›</button>
    <button id=3 class="btnDD" onclick="showEle(102,301,3010)">Quarterly Vyaj Party ğŸ‘®</button>

    <button id=11 class="btnDD" onclick="insertTran(true, true, false)">Transaction â›”âœï¸</button>
    <button id=12 class="btnDD" onclick="showEle(401,4010)">Delete Party â›”ğŸ‘®</button>

    <button id=21 class="btnDD" onclick="showMtable(116)">Ele 116 ğŸ˜±</button>
    <button id=22 class="btnDD" onclick="showMtable(119)">Ele 119 ğŸ¥¶</button>
    <button id=23 class="btnDD" onclick="showEle(501,502,503,504,505,506,5010)">Transaction ğŸ’°</button>
    <button id=24 class="btnDD" onclick="saveHavala('mvamt')">Monthly Vyaj Havala ğŸ’¸</button>
    <button id=25 class="btnDD" onclick="saveHavala('mbamt')">Monthly Bhada Havala ğŸ’µ</button>
    <button id=26 class="btnDD" onclick="saveHavala('qvamt')">Quarterly Vyaj Havala ğŸ’°</button>

    <button id=31 class="btnDD" onclick="insertTran(false, false, false)">Daybook ğŸ“•</button>
    <button id=32 class="btnDD" onclick="showDashboard()">Dashboard ğŸ“Š</button>
    <button id=33 class="btnDD" onclick="viewReceivables()">Receivables ğŸ’´</button>
    <button id=34 class="btnDD" onclick="viewLedger()">Ledgers & Groups ğŸ§‘ğŸ¼â€ğŸ¤â€ğŸ§‘ğŸ¼</button>

    <input id=101 class="input-box" type="text"/><label class="label">Select Plot No</label>
    <input id=102 class="input-box" type="text"/><label class="label">Name</label>
    <input id=103 class="input-box" type="number"/><label class="label">Meter Reading</label>
    <input id=104 class="input-box" type="number"/><label class="label">Monthly Bhadu</label>
    <button id=1010 class="btnSV block mx-auto" onclick="saveBhaduvat()">ğŸ’¾</button>

    <input id=201 class="input-box" type="number"/><label class="label">Monthly Vyaj</label>
    <button id=2010 class="btnSV block mx-auto" onclick="saveParty('mv')">ğŸ’¾</button>

    <input id=301 class="input-box" type="number"/><label class="label">Quarterly Vyaj</label>
    <button id=3010 class="btnSV block mx-auto" onclick="saveParty('qv')">ğŸ’¾</button>

    <input id=401 class="input-box" type="text"/><label class="label">Select Party</label>
    <button id=4010 class="btnSV block mx-auto" onclick="deleteParty()">ğŸ—‘ï¸</button>

    <input id=501 class="input-box date-input" type="text"/><label class="label">Date</label>
    <input id=502 class="input-box" type="text"/><label class="label">From</label>
    <input id=503 class="input-box" type="text"/><label class="label">To</label>   
    <input id=504 class="input-box" type="number"/><label class="label">Amount</label>
    <input id=505 class="input-box" type="text"/><label class="label">Narration</label>
    <input id=506 class="input-box" type="text"/><label class="label">ğŸ§® Calculator</label>
    <div id=5010 class="flex">
        <button class="btnSV ml-[70px]" onclick="saveTransaction()">ğŸ’¾</button>
        <button class="btnSV ml-[200px]" title="View Daybook" onclick="insertTran(true, true, false)">ğŸ“™</button>
    </div>
</div>

<div id="mtblCont" class="hidden card w-fit p-2 mt-[50px] rounded-lg">
    <table id="metersTable"><thead><tr><th>Name</th><th>O Read</th><th>N Read â†“â†“</th><th>Consum</th><th>AdjUnt</th><th>Amt â†“â†“</th></tr></thead><tbody id="metersTableBody"></tbody></table>
    <button class="btnSV inline-block ml-10 mb-5" title="Claculate Bill" onclick="calculate()">ğŸ“ </button>
    <button class="btnSV inline-block ml-10 mb-5" title="Save Bill" onclick="saveData()" style="display:none;" id="saveBtn">ğŸ’¾</button>
</div>

<div id="tblCont" class="hidden card w-fit mt-[50px] rounded-lg">
    <div><input id="searchBox" class="card w-full max-w-md px-2 h-10 border border-blue-600 rounded-lg" placeholder="Search..." type="text" autocomplete="off"/></div>
    <div class="w-full max-w-md flex gap-1 justify-left">
        <button id="excelBtn" class="btn block mx-auto w-10 h-10 p-1 rounded-full text-center ring-green-500 hover:ring-4 transition">XL</button>
        <button id="pdfBtn" class="btn block mx-auto w-10 h-10 p-1 rounded-full text-center ring-green-500 hover:ring-4 transition">PDF</button>
        <button id="printBtn" class="btn block mx-auto w-10 h-10 p-1 rounded-full text-center ring-green-500 hover:ring-4 transition">ğŸ–¨ï¸</button>
    </div>
    <div class="overflow-x-auto"><div id="table" class="rounded-lg mx-auto text-[18px] font-[Roboto]"></div></div>
</div>

<div id="dashCont" class="hidden card max-w-md p-2 mt-[50px] rounded-lg"><h2>Dashboard</h2><canvas id="dashboardChart"></canvas></div>

<div id="lgnCont" class="hidden card max-w-md p-2 mt-[50px] rounded-lg">
    <h2 class="ml-5 py-5 text-[#e92c7b] text-xl">Login</h2>
    <input class="input-box" id="loginEmail" type="email" /><label for="loginEmail" class="label">Email</label>
    <input class="input-box" id="loginPassword" type="password" /><label for="loginPassword" class="label">Password</label>
    <button class="btnSV block mx-auto" title="Login" onclick="login()">ğŸ ï¸</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script> flatpickr(".date-input", { dateFormat: "d-m-Y", defaultDate: new Date() }); </script>

<script type="module">
    import {initializeApp} 
    from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut,} 
    from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import {getFirestore, collection, getDocs, getDoc, doc, deleteDoc, updateDoc, addDoc, writeBatch } 
    from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    const firebaseConfig = {
        apiKey: "AIzaSyDrI9vIDUePbzHrTSRCKAcJ7oCfCIrSIUI",
        authDomain: "apps-a5358.firebaseapp.com",
        projectId: "apps-a5358",
        storageBucket: "apps-a5358.firebasestorage.app",
        messagingSenderId: "796844706882",
        appId: "1:796844706882:web:16b8e105ba28b1390971db",
        measurementId: "G-9TVN21KVF3"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    let meters = [], balances = {}, mainMeter = null, groupId = null, currentDocId = null, cachedData = null;
    
    onAuthStateChanged(auth, async (user) => {
        if (user) { 
            const docRef = doc(db, "users", user.uid);
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) { const dbName = docSnap.data().db; window.tranCol = collection(db, dbName);};
            showCont('topBar'); 
            await fetchAllOnce();
            await loadDropdownData(); 
        } else { showCont("lgnCont"); } 
    });  
    
    document.addEventListener('DOMContentLoaded', () => {
        const wrapperClass = "relative mt-6";
        const inputClass = "peer w-full border-b-2 border-gray-500 bg-transparent pt-2 focus:outline-none focus:border-yellow-600";
        const labelClass = "absolute top-2 left-0 text-gray-500 transform -translate-y-6 peer-placeholder-shown:translate-y-0 peer-placeholder-shown:scale-80 peer-focus:text-yellow-600";

        document.querySelectorAll('.input-box').forEach(input => {
            const label = input.nextElementSibling;
            if (!label || label.tagName !== "LABEL") return;

            const wrapper = document.createElement("div");
            wrapper.className = wrapperClass;
            input.parentNode.insertBefore(wrapper, input);
            wrapper.appendChild(input);
            wrapper.appendChild(label);

            input.classList.add(...inputClass.split(' '));
            label.classList.add(...labelClass.split(' '));
            input.setAttribute("placeholder", " ");
            input.setAttribute("autocomplete", "off");

            if (input.id === "from1" || input.id === "to1") {
                const btn = document.createElement("button");
                btn.innerHTML = "âœš";
                btn.type = "button";
                btn.className = "absolute right-1 top-2 text-green-500";
                btn.setAttribute("onclick", "showCont('newCont')")
                wrapper.appendChild(btn);
            }

            if (input.type === "text") {
                input.addEventListener('input', function () {
                    const start = this.selectionStart;
                    const end = this.selectionEnd;
                    this.value = this.value.toLowerCase().replace(/\b\w/g, char => char.toUpperCase());
                    this.setSelectionRange(start, end); 
                }); 
            }
        });
    });   
    
    const btnClass2 = "block w-full max-w-md px-5 py-3 text-left cursor-pointer";
    document.querySelectorAll('.btnDD').forEach(btn => { btn.classList.add(...btnClass2.split(' ')); });
    const btnClass3 = "mt-10 mb-2 text-[30px] rounded-full duration-500 hover:scale-150 cursor-pointer ring-green-500 hover:ring-4";
    document.querySelectorAll('.btnSV').forEach(btn => { btn.classList.add(...btnClass3.split(' ')); });    
    
    document.getElementById("505").addEventListener("focus", async function () {
        await viewReceivables(false);
        const fromParty = document.getElementById("from1").value.trim();
        const toParty = document.getElementById("to1").value.trim();
        const partiesToCheck = [fromParty, toParty];
        partiesToCheck.forEach(party => { if (party && party !== "Gpzip") { const bal = balances[party] || 0; document.getElementById("balanceInfo").textContent = `${party}: ${bal.toFixed(0)}`;} }); 
    });

    window.showEle = function (...ids) {
        document.getElementById("menuCont").style.setProperty('display', 'none', 'important');
        const cont = document.getElementById("btnCont");
        cont.style.setProperty('display', 'block', 'important');
        Array.from(cont.children).forEach(child  => child.style.setProperty('display', 'none', 'important'));
        ids.forEach(id => {
            let el = document.getElementById(id);
            if (el) {
                if (el.tagName === "INPUT" || el.tagName === "LABEL") { el = el.parentElement;}
                el.style.setProperty('display', 'block', 'important');
            }
        });
    };

    window.showCont = function (...idToShow) {
        const allIds = ['menuCont', 'btnCont', 'bhdCont', 'mvpCont', 'qvpCont', 'delCont', 'tranCont', 'mtblCont', 'tblCont', 'dashCont', 'lgnCont'];
        allIds.forEach(id => { const el = document.getElementById(id); if (el) { el.style.setProperty('display', 'none', 'important'); } });
        idToShow.forEach(id => { const el = document.getElementById(id); if (el) { el.style.setProperty('display', 'block', 'important'); } });
    };   
    
    window.clear = function () { loadDropdownData(); document.querySelectorAll("input").forEach(el => { if (el.id !== "date") { el.value = ""; } }); };
    
    document.getElementById("506").addEventListener("keydown", function (e) {
        if (e.key === "Enter") {
            const raw = this.value.trim();
            if (/^[\d+\-*/().\s]+$/.test(raw)) {
                const result = Function('"use strict";return (' + raw + ')')();
                this.value = result; } 
            else { alert("Invalid expression. Only numbers and + - * / allowed. ğŸ¤•"); } 
        } 
    });
    
    window.fetchAllOnce = async function () { 
        if (cachedData) { return cachedData; } 
        const snapshot = await getDocs(tranCol);
        cachedData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); 
        return cachedData; 
    };
    
    window.loadDropdownData = async function () {
        const transactionsData = await fetchAllOnce();
        const nameSet = new Set();
        transactionsData.forEach((data) => { const name = (data.tparty || "").trim(); if (name.length > 0) { nameSet.add(name); } });
        const plot_list = ["116", "119"]; 
        const names_list = [...nameSet].sort((a, b) => a.localeCompare(b));

        attachDropdown(document.getElementById("101"), plot_list);
        ["401","502","503"].forEach(id => attachDropdown(document.getElementById(id), names_list));
    }; 
    window.attachDropdown = function (inputElement, dataList) {
        if (inputElement._dropdownCleanup) { inputElement._dropdownCleanup(); }
        let wrapper = inputElement.parentElement;

        if (!wrapper.classList.contains("relative")) {
            wrapper = document.createElement("div");
            wrapper.className = "relative w-full";
            inputElement.parentNode.insertBefore(wrapper, inputElement);
            wrapper.appendChild(inputElement);
        }

        let dropdown = document.createElement("ul");
        dropdown.className = "card absolute z-50 w-full h-[300px] overflow-y-auto hidden rounded-b-lg";
        wrapper.appendChild(dropdown);

        function filterList() {
            const search = inputElement.value.toLowerCase();
            const matches = dataList.filter(item => item.toLowerCase().includes(search));
            populateDropdown(matches);
        }

        function populateDropdown(list) {
            dropdown.innerHTML = "";
            list.forEach(item => {
                const btn = document.createElement("button");
                btn.textContent = item;
                btn.className = "btnDD block w-full text-left px-2 py-3 cursor-pointer border-b border-gray-300 last:border-b-0";
                btn.addEventListener('click', () => {
                    inputElement.value = item;
                    dropdown.classList.add("hidden");
                });
                dropdown.appendChild(btn);
            });
        }

        const onInput = () => { dropdown.classList.remove("hidden"); filterList(); };
        const onClick = () => { dropdown.classList.remove("hidden"); filterList(); };
        const onBlur = () => {
            setTimeout(() => {
                const value = inputElement.value.trim().toLowerCase();
                if (value && !dataList.some(item => item.toLowerCase() === value)) {
                    alert("Please select a valid option from the list. ğŸš«");
                    inputElement.value = "";
                    return;
                }
            }, 200);
        };

        const onDocClick = (e) => { if (!wrapper.contains(e.target)) dropdown.classList.add("hidden"); };
        inputElement.addEventListener("input", onInput);
        inputElement.addEventListener("click", onClick);
        inputElement.addEventListener("blur", onBlur);
        document.addEventListener("click", onDocClick);

        inputElement._dropdownCleanup = () => {
            inputElement.removeEventListener("input", onInput);
            inputElement.removeEventListener("click", onClick);
            inputElement.removeEventListener("blur", onBlur);
            document.removeEventListener("click", onDocClick);

            if (dropdown.parentNode) dropdown.parentNode.removeChild(dropdown);
            inputElement._dropdownCleanup = null;
        };
    };    
    window.createEditableTable = function (rows, columns, showDelete = true, showUpdate = true, editable = false) {
        if (window.table && typeof window.table.destroy === "function") window.table.destroy();
        const isMobile = window.innerWidth < 768;  
        const searchId = document.getElementById('searchBox');
        let fullColumns = columns.map(col => {
            if (isMobile && col.field === "id") return { ...col, visible: false };
            return { ...col, editor: editable ? col.editor || "input" : false };
        });

        if (!isMobile) {
            if (showDelete) {
                fullColumns.push({
                    title: "",
                    field: "__delete",
                    formatter: () => `<div class="text-center cursor-pointer">â›”</div>`,
                    width: 70,
                    hozAlign: "center",
                    cellClick: async (e, cell) => {
                        e.stopPropagation();
                        const rowData = cell.getRow().getData();
                        const confirmed = confirm("Delete? Are You Sure?");
                        if (confirmed && rowData.id) {
                            await deleteDoc(doc(tranCol, rowData.id));
                            cell.getRow().delete();
                            if (cachedData) cachedData = cachedData.filter(doc => doc.id !== rowData.id);
                        }
                    },
                });
            }

            if (showUpdate) {
                fullColumns.push({
                    title: "",
                    field: "__update",
                    formatter: () => `<div class="text-center cursor-pointer">âœï¸</div>`,
                    width: 70,
                    hozAlign: "center",
                    cellClick: (e, cell) => {
                        e.stopPropagation();
                        const rowData = cell.getRow().getData();
                        currentDocId = rowData.id;
                        showTransactionContainer(rowData);
                    },
                });
            }
        }

        window.table = new Tabulator(document.getElementById('table'), {
            data: rows,
            layout: "fitDataTable",
            reactiveData: true,
            rowHeight: 40,
            maxHeight: "600px",
            headerVisible: !isMobile,
            columns: fullColumns,
            rowFormatter: isMobile ? function (row) {
                row.getElement().style.display = "block";
                let d = row.getData();
                let card = document.createElement("div");
                card.className = `w-full max-w-md bg-white grid grid-cols-[100px_1fr] mb-1 text-[18px] font-[Roboto] rounded-lg border border-green-500`;

                let inner = "";
                columns.forEach(col => {
                    if (col.field !== "__delete" && col.field !== "__update") {
                        const val = d[col.field];
                        if (val !== undefined && val !== null && val !== "") {
                            inner += ` <div class="text-gray-600 text-right px-1">${col.title}:</div> <div class="text-gray-900 px-1">${val}</div> `;
                        }
                    }
                });

                if (showDelete || showUpdate) {
                    inner += `<div class="col-span-2 pb-2 pr-5 flex justify-end gap-20 rounded-lg">`;
                    if (showDelete) inner += `<span class="delete-btn cursor-pointer">â›”</span>`;
                    if (showUpdate) inner += `<span class="update-btn cursor-pointer">âœï¸</span>`;
                    inner += `</div>`;
                }

                card.innerHTML = inner;
                row.getElement().innerHTML = "";
                row.getElement().appendChild(card);

                if (showDelete) {
                    card.querySelector(".delete-btn")?.addEventListener("click", async (e) => {
                        e.stopPropagation();
                        const confirmed = confirm("Delete? Are You Sure?");
                        if (confirmed && d.id) {
                            await deleteDoc(doc(tranCol, d.id));
                            row.delete();
                            if (cachedData) cachedData = cachedData.filter(doc => doc.id !== d.id);
                        }
                    });
                }

                if (showUpdate) {
                    card.querySelector(".update-btn")?.addEventListener("click", (e) => {
                        e.stopPropagation();
                        currentDocId = d.id;
                        showTransactionContainer(d);
                    });
                }
            } : undefined
        });

        document.getElementById('excelBtn')?.addEventListener("click", () => { window.table.download("xlsx", "data.xlsx", { sheetName: "Sheet1" }); });
        document.getElementById('pdfBtn')?.addEventListener("click", () => { window.table.download("pdf", "data.pdf", { orientation: "portrait" }); });
        document.getElementById('printBtn')?.addEventListener("click", () => { window.table.print(false, true); });
        bindSearch();
    };    
    window.bindSearch = function () {
        const searchbox = document.getElementById("searchBox");
        searchbox.addEventListener("input", function () {
            const value = this.value.toLowerCase().trim();
            table.setFilter(function (data) {
                if (value === "") { return true; }
                return Object.values(data).some(val => String(val).toLowerCase().includes(value)); 
            }); 
        }); 
    };
    window.showTransactionContainer = function (rowData) { 
        showEle(501,502,503,504,505,506,5010,5011);
        document.getElementById('tblCont').style.setProperty('display', 'none', 'important');
        document.getElementById("501").value = rowData.date || "";
        document.getElementById("502").value = rowData.fparty || "";
        document.getElementById("503").value = rowData.tparty || "";
        document.getElementById("504").value = rowData.amount || "";
        document.getElementById("505").value = rowData.nar || "";
    };   
    window.insertTran = async function (showDelete = true, showUpdate = true, editable = false) {
        const data = await fetchAllOnce();
        const rows = [];
        data.forEach(item => {
            if (!item.date || !item.fparty) return;
            rows.push({
                id: item.id,
                date: item.date.split('-').reverse().join('-').replace(/(\d{2})-(\d{4})$/, '$1-$2'),
                ttype: item.ttype, 
                fparty: item.fparty || "",
                tparty: item.tparty || "", 
                nar: item.nar || "", 
                amount: item.amount || "", 
                oread: item.oread || "",
                nread: item.nread || "", 
                unitdiff: item.unitdiff || "", 
            }); 
        });

        const columns = [
            {title: "Date", field: "date"}, 
            {title: "Type", field: "ttype"}, 
            {title: "From", field: "fparty"}, 
            {title: "To", field: "tparty"},  
            {title: "Amount", field: "amount", hozAlign: "right"}, 
            {title: "Oread", field: "oread", hozAlign: "right"},
            {title: "Nread", field: "nread", hozAlign: "right"}, 
            {title: "Udiff", field: "unitdiff", hozAlign: "right"},
            {title: "Narr", field: "nar"}, 
        ];
        createEditableTable(rows, columns, showDelete, showUpdate, editable);
        showCont("tblCont"); 
    };
    
    window.saveBhaduvat = async function () {
        const group = document.getElementById("plotgroup").value.trim();
        const name = document.getElementById("bhaduvatname").value.trim();
        const nread = document.getElementById("meterreading").value.trim();
        const mbamt = document.getElementById("mbamt").value.trim();
        if (!group || !name || !nread || !mbamt) { return alert("Group, Name, Meter Reading\nMonthly Bhada Amount Required."); }
        const newDocData = { group: Number(group), nread: Number(nread), tparty: name, mbamt: Number(mbamt), date: new Date().toISOString().split('T')[0], };
        const docRef = await addDoc(tranCol, newDocData);
        const savedData = { id: docRef.id, ...newDocData };
        cachedData.push(savedData); 
        clear();
    };
    window.saveParty = async function (partyType) {
        const nameInputId = partyType.toLowerCase() + "partyname";
        const amtInputId = partyType.toLowerCase() + "amt";
        const amtField = partyType.toLowerCase() + "amt";
        const name = document.getElementById(nameInputId).value.trim();
        const amt = document.getElementById(amtInputId).value.trim();

        if (!name || !amt) { return alert(`Name, ${partyType === "mv" ? "Monthly" : "Quarterly"} Vyaj Amount Required.`); }
        const newDocData = { group: partyType + "Party", tparty: name, [amtField]: Number(amt), date: new Date().toISOString().split('T')[0], };
        const docRef = await addDoc(tranCol, newDocData);
        const savedData = { id: docRef.id, ...newDocData };
        cachedData.push(savedData);
        clear();
    };
    window.saveHavala = async function (type) {
        const fieldMap = { mbamt: "mbamt", mvamt: "mvamt", qvamt: "qvamt" };
        const ttypeMap = { mbamt: "Bhadu", mvamt: "Vyaj", qvamt: "Vyaj" };
        const amtField = fieldMap[type];
        const ttypeValue = ttypeMap[type];
        const newItems = [];
        
        if (confirm(`Are you sure you want to save ${type.toUpperCase()} Havala?`)) {
            const itemsToProcess = cachedData.filter(data => 
                data[amtField] !== undefined && data[amtField] !== null && 
                (typeof data[amtField] !== 'string' || data[amtField] !== '') &&
                data.tparty !== undefined
            );
            const batch = writeBatch(db);
            for (const item of itemsToProcess) {
                const newDoc = { ttype: ttypeValue, tparty: item.tparty, fparty: "Gpzip", amount: Number(item[amtField]), date: new Date().toISOString().split('T')[0], };
                const newDocRef = doc(tranCol);
                batch.set(newDocRef, newDoc);
                newItems.push(newDoc);
            }
            await batch.commit();
            cachedData.push(...newItems);
        }
    };
    
    window.getInputByIdx = function (cls, idx) { return document.querySelector(`.${cls}[data-index="${idx}"]`); }
    window.fetchCustomers = async function (groupId) {
        const transactionsData = await fetchAllOnce(); 
        const namesSet = new Set();
        transactionsData.forEach(data => { if (data.group === groupId) { if (data.tparty) { namesSet.add(data.tparty.trim()); } } });
        const names = Array.from(namesSet);
        if (names.length === 0) return [];
        const customers = [];

        for (const name of names) {
            let latestDoc = null;
            let latestDate = new Date(0);
            transactionsData.forEach(data => {
                if (data.tparty === name && data.nread !== undefined && data.date) {
                    const docDate = new Date(data.date);
                    if (docDate > latestDate) { latestDate = docDate; latestDoc = data; }
                }
            });
            const oldReading = latestDoc && latestDoc.nread ? latestDoc.nread : 0;
            customers.push({ name, oldReading, newReading: '', amount: '', });
        }
        return customers;
    };
    window.renderTable = async function () {
        const tbody = document.getElementById("metersTableBody");
        tbody.innerHTML = "";
        const mainMeterName = `Main ${groupId}`;
        const sortedIndices = meters
            .map((_, idx) => idx)
            .sort((ai, bi) => {
                const a = meters[ai], b = meters[bi];
                const aPriority = (a.name === mainMeterName) ? 0 : 1;
                const bPriority = (b.name === mainMeterName) ? 0 : 1;
                if (aPriority !== bPriority) return aPriority - bPriority;
                return a.name.localeCompare(b.name);
            });
        sortedIndices.forEach((idx) => {
            const meter = meters[idx];
            tbody.insertAdjacentHTML("beforeend", `
                <tr data-index="${idx}">
                    <td>${meter.name}</td><td>${meter.oldReading}</td>
                    <td><input type="number" min="${meter.oldReading}" value="${meter.newReading !== undefined ? meter.newReading : ''}" data-index="${idx}" class="card newReadingInput w-[90px] text-right" /></td>
                    <td class="consumption">-</td><td class="adjustedUnits">-</td>
                    <td><input type="number" min="0" value="${meter.amount !== undefined ? meter.amount : ''}" data-index="${idx}" class="card amountInput w-[70px] text-right" /></td>
                </tr>
            `);
        });
    };  
    window.calculate = function () {
        const mainMeterName = `Main ${groupId}`;
        const mainIndex = meters.findIndex(m => m.name === mainMeterName);
        const mainNewReadingInput = getInputByIdx("newReadingInput", mainIndex);
        const mainAmountInput     = getInputByIdx("amountInput", mainIndex);

        let mainNewReading = parseFloat(mainNewReadingInput.value);
        if (isNaN(mainNewReading) || mainNewReading < meters[mainIndex].oldReading) { 
            return alert( `Main Meter new reading must be > old reading (${meters[mainIndex].oldReading})`); 
        }
        meters[mainIndex].newReading = mainNewReading;
        meters[mainIndex].consumption = mainNewReading - meters[mainIndex].oldReading;

        let mainAmount = parseFloat(mainAmountInput.value);
        if (isNaN(mainAmount) || mainAmount <= 0) { return alert("Please enter valid Main Meter Amount > 0"); }
        meters[mainIndex].amount = mainAmount;

        for (let i = 0; i < meters.length; i++) {
            if (i === mainIndex) continue;
            const input = getInputByIdx("newReadingInput", i);
            if (!input) return alert(`Row for "${meters[i].name}" not found.`);

            let newRead = parseFloat(input.value);
            if (isNaN(newRead) || newRead <= meters[i].oldReading) { 
                return alert( `New reading for customer "${meters[i].name}" must be > old reading (${meters[i].oldReading})`); 
            }
            meters[i].newReading = newRead;
            meters[i].consumption = newRead - meters[i].oldReading;
        }

        const totalCustomerConsumption = meters.reduce((sum, m, idx) => { 
            return idx !== mainIndex ? sum + m.consumption : sum; 
        }, 0);

        const diff = meters[mainIndex].consumption - totalCustomerConsumption;        
        meters.forEach((meter, idx) => {
            if (idx === mainIndex) { meter.adjustedUnits = meter.consumption; } 
            else {
                const shareDiff = (meter.consumption / totalCustomerConsumption) * diff;
                meter.adjustedUnits = meter.consumption + shareDiff;
                meter.amount = (meter.adjustedUnits / meters[mainIndex].consumption) * meters[mainIndex].amount;
            }
        });

        meters.forEach((m, idx) => {
            const row = document.querySelector(`#metersTableBody tr[data-index="${idx}"]`);
            if (!row) return;
            row.querySelector(".consumption").textContent = m.consumption.toFixed(0);
            row.querySelector(".adjustedUnits").textContent = m.adjustedUnits.toFixed(0);
            const amtInput = row.querySelector(".amountInput");
            if (amtInput) amtInput.value = m.amount.toFixed(0);
        });
        document.getElementById("saveBtn").style.display = "inline-block";
    };    
    window.saveData = async function () {
        const batch = writeBatch(db);
        const newItems = [];
        const mainMeterName = `Main ${groupId}`;
        const mainIndex = meters.findIndex(m => m.name === mainMeterName);
        
        for (let i = 0; i < meters.length; i++) {
            const meter = meters[i];
            const unitDiff = meter.adjustedUnits - meter.consumption;
            const newDocRef = doc(tranCol);
            const tranData = { ttype: "Ebill", tparty: meter.name, fparty: "Gpzip", oread: meter.oldReading, nread: meter.newReading, unitdiff: Math.round(unitDiff), date: new Date().toISOString().split('T')[0], };
            if (i !== mainIndex) { tranData.amount = Math.round(meter.amount); }
            batch.set(newDocRef, tranData);
            newItems.push(tranData);
        }
        await batch.commit();
        cachedData.push(...newItems);
        document.getElementById("mtblCont").style.setProperty('display', 'none', 'important');
        alert('Data saved, success');
    };    
    window.showMtable = async function (grpId) { 
        groupId = grpId; 
        meters = await fetchCustomers(groupId); 
        renderTable(); 
        showCont('mtblCont'); 
        document.getElementById("saveBtn").style.display = "none";
    };
    
    window.saveTransaction = async function () {
        const odate = document.getElementById("date");
        const fparty = document.getElementById("from1").value.trim();
        const tparty = document.getElementById("to1").value.trim();
        const amount = parseFloat(document.getElementById("amt").value.trim()) || 0;
        const nar = document.getElementById("nar").value.trim();
        
        if (!odate || !fparty || !tparty || isNaN(amount) || amount <= 0) { return alert("Please fill all required fields properly\nAmount must be a number > 0"); }       
        const date = odate._flatpickr.formatDate(odate._flatpickr.parseDate(odate.value.trim(), "d-m-Y"), "Y-m-d");
        const tranData = {ttype: "Receipt", date, fparty, tparty, amount };
        
        if (nar) tranData.nar = nar;
        if (currentDocId) { 
            const docRef = doc(tranCol, currentDocId); 
            await updateDoc(docRef, tranData); 
            const index = cachedData.findIndex(item => item.id === docRef.id);
            if (index !== -1) { cachedData[index] = { ...cachedData[index], ...tranData }; }
            insertTran();
        } 
        else { 
            const newDocRef = await addDoc(tranCol, tranData); 
            cachedData.push({ id: newDocRef.id, ...tranData });
        }
        clear(); currentDocId = null; 
    };
    
    window.deleteParty = async function () {
        const name = document.getElementById("deleteparty").value.trim();
        if (!name) { return alert("Please enter a name"); }
        if (confirm('Are you sure you want to Delete this party and all related transactions?\nHoshiyar ğŸ™‹ğŸ»â€â™‚ï¸ğŸ¤“\nThis action cannot be undone. ğŸ˜±')) {
            const batch = writeBatch(db);
            const docsToDelete = cachedData.filter( data => data.fparty === name || data.tparty === name );
            for (const docData of docsToDelete) { batch.delete(doc(tranCol, docData.id)); }
            await batch.commit();
            cachedData = cachedData.filter( data => data.fparty !== name && data.tparty !== name );
        }
        clear();
    };

    window.viewReceivables = async function (showTable = true) {
        const data = await fetchAllOnce();
        balances = {};
        let rows = [];
        data.forEach(item => {
            if (item.fparty) { const party = item.fparty.trim(); balances[party] = (balances[party] || 0) + parseFloat(item.amount || "0"); }
            if (item.tparty) { const party = item.tparty.trim(); balances[party] = (balances[party] || 0) - parseFloat(item.amount || "0"); }
        });

        if (showTable) {
            for (const party in balances) { if ((balances[party]) !== 0) { rows.push({ party: party, amount: (balances[party]).toFixed(0) }); } }
            const columns = [ { title: "Party", field: "party", width: 240 }, { title: "Amount", field: "amount", width: 108, hozAlign: "right" } ];
            createEditableTable(rows, columns, false, false, false);
            showCont("tblCont");
        }
    };
    
    window.viewLedger = async function () {
        const data = await fetchAllOnce();
        const rows = [];
        data.forEach(item => {
            const group = item.group ?? "";
            const name = item.tparty ?? "";
            if ((group !== "" && group !== null && group !== undefined) &&
                (name !== "" && name !== null && name !== undefined)) {
                rows.push({ group, name });
            }
        });
        const columns = [ { title: "Group", field: "group", width: 108 }, { title: "Name", field: "name", width: 240 }, ];
        createEditableTable(rows, columns, false, false, false);
        showCont("tblCont");
    };
    
    window.showDashboard = async function () {
        showCont("dashCont");
        const transactionsData = await fetchAllOnce();
        const monthlyData = {};

        transactionsData.forEach((data) => {
            let jsDate = new Date(data.date);
            if (isNaN(jsDate)) return;
            const month = jsDate.toLocaleString('default', { month: 'short' });
            if (!monthlyData[month]) { monthlyData[month] = { bhadu: 0, vyaj: 0 }; }
            const ttype = (data.ttype || "").trim().toLowerCase();
            if (ttype === "bhadu") { monthlyData[month].bhadu += data.amount || 0; } 
            if (ttype === "vyaj") { monthlyData[month].vyaj += data.amount || 0; } 
        });

        const monthOrder = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
        const labels = Object.keys(monthlyData).sort((a, b) => monthOrder.indexOf(a) - monthOrder.indexOf(b));
        const sales = labels.map(m => monthlyData[m].bhadu);
        const purchase = labels.map(m => monthlyData[m].vyaj);
        const textColor = getComputedStyle(document.body).getPropertyValue('--text-color').trim();

        if (window.dashboardChart instanceof Chart) { window.dashboardChart.destroy(); }
        window.dashboardChart = new Chart(document.getElementById("dashboardChart"), {
            type: 'bar',
            data: { 
                labels, 
                datasets: [ 
                    { label: "Bhadu", data: sales, backgroundColor: "rgba(2, 255, 25, 1)" }, 
                    { label: "Vyaj", data: purchase, backgroundColor: "rgba(242, 51, 217, 1)" } 
                ] 
            }, 
            options: { 
                responsive: true, 
                plugins: { 
                    legend: {
                        labels: { color: textColor }
                    },
                    datalabels: { 
                        anchor: 'end', 
                        align: 'start', 
                        formatter: value => value.toLocaleString(), 
                        font: { weight: 'bold' },
                        color: textColor              
                    } 
                }, 
                scales: { 
                    x: { ticks: { color: textColor } },  
                    y: { beginAtZero: true, ticks: { color: textColor } } 
                } 
            },
        }); 
    };

    window.switchTheme = function () {
        showCont();
        if (document.body.classList.contains('light-mode')) {
            document.body.classList.add('dark-mode');
            document.body.classList.remove('light-mode');
        } else {
            document.body.classList.add('light-mode');
            document.body.classList.remove('dark-mode');
        }
    };

    window.logout = async function () { 
        showCont();
        if (confirm("Are you sure you want to logout?")) { 
            await signOut(auth); showCont("lgnCont"); 
        } 
    };

    window.login = async function () {
        const email = document.getElementById("loginEmail").value;
        const password = document.getElementById("loginPassword").value;
        const userCredential = await signInWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;
        const docRef = doc(db, "users", user.uid);
        const docSnap = await getDoc(docRef);
        if (docSnap.exists() && docSnap.data().approved === true) { showCont("topBar"); }
    };
    
    window.addEventListener("beforeunload", function (e) { e.preventDefault(); e.returnValue = ""; });
    
</script>
</body>
</html>
