<!DOCTYPE html><html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Umesh's Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script src="https://unpkg.com/tabulator-tables@5.5.0/dist/js/tabulator.min.js"></script>    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>    
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono&display=swap" rel="stylesheet">
    <link href="https://unpkg.com/tabulator-tables@5.5.0/dist/css/tabulator.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
</head>
<body class="min-h-screen bg-gray-900 text-white font-serif text-[16px]">
<header id="topbar" class="w-full bg-gray-900 text-green-500 px-5 py-3 cursor-pointer hidden text-[20px]">Start Here 🙋🏻‍♂️</header>
<nav id="top-nav" class="fixed top-0 left-0 h-[580px] w-full bg-gray-900 transform -translate-y-full transition-transform duration-300 z-50 overflow-y-auto">
    <ul>
        <li><a class="block hover:bg-indigo-600 px-2 py-3 bg-indigo-700 cursor-pointer menu-link" id="close">Home</a></li><li class="border-t border-gray-500"></li>
        <li><a class="block hover:bg-sky-600 px-2 py-3 bg-sky-700 cursor-pointer menu-link" onclick="showDashboard()">Dashboard</a></li><li class="border-t border-gray-500"></li>
        <li><a class="block hover:bg-green-600 px-2 py-3 bg-green-700 cursor-pointer menu-link" onclick="showCont('ledger')">Ledger</a></li><li class="border-t border-gray-500"></li>
        <li><a class="block hover:bg-green-600 px-2 py-3 bg-green-700 cursor-pointer menu-link" onclick="showCont('product')">Product</a></li><li class="border-t border-gray-500"></li>
        <li><a class="block hover:bg-green-600 px-2 py-3 bg-green-700 cursor-pointer menu-link" onclick="showCont('transaction')">Transaction</a></li><li class="border-t border-gray-500"></li>
        <li><a class="block hover:bg-red-600 px-2 py-3 bg-red-700 cursor-pointer menu-link" onclick="insertProdLed('Opening Balance')">Update Ledger</a></li><li class="border-t border-gray-500"></li>
        <li><a class="block hover:bg-red-600 px-2 py-3 bg-red-700 cursor-pointer menu-link" onclick="insertProdLed('Opening Stock')">Update Product</a></li><li class="border-t border-gray-500"></li>
        <li><a class="block hover:bg-red-600 px-2 py-3 bg-red-700 cursor-pointer menu-link" onclick="insertTran(true, true, false, false)">Update Transaction</a></li><li class="border-t border-gray-500"></li>
        <li><a class="block hover:bg-fuchsia-600 px-2 py-3 bg-fuchsia-700 cursor-pointer menu-link" onclick="viewSummary('payables')">Payables</a></li><li class="border-t border-gray-500"></li>
        <li><a class="block hover:bg-fuchsia-600 px-2 py-3 bg-fuchsia-700 cursor-pointer menu-link" onclick="viewSummary('receivables')">Receivables</a></li><li class="border-t border-gray-500"></li>
        <li><a class="block hover:bg-fuchsia-600 px-2 py-3 bg-fuchsia-700 cursor-pointer menu-link" onclick="showCont('profitLoss')">Profit & Loss</a></li><li class="border-t border-gray-500"></li>
        <li><a class="block hover:bg-amber-600 px-2 py-3 bg-amber-700 cursor-pointer menu-link">Balance Sheet</a></li><li class="border-t border-gray-500"></li>
        <li><a class="block hover:bg-amber-600 px-2 py-3 bg-amber-700 cursor-pointer menu-link">Khatavahi</a></li><li class="border-t border-gray-500"></li>
        <li><a class="block hover:bg-indigo-600 px-2 py-3 bg-indigo-700 cursor-pointer menu-link" onclick="insertTran(false, false, false, false)">DayBook</a></li><li class="border-t border-gray-500"></li>
        <li><a class="block hover:bg-indigo-600 px-2 py-3 bg-indigo-700 cursor-pointer menu-link" onclick="insertTran(false, false, false, true)">CashBook</a></li><li class="border-t border-gray-500"></li>
        <li><a class="block hover:bg-indigo-600 px-2 py-3 bg-indigo-700 cursor-pointer menu-link" onclick="viewSummary('sales')">Sales Register</a></li><li class="border-t border-gray-500"></li>
        <li><a class="block hover:bg-indigo-600 px-2 py-3 bg-indigo-700 cursor-pointer menu-link" onclick="viewSummary('purchase')">Purchase Register</a></li><li class="border-t border-gray-500"></li>
        <li><a class="block hover:bg-indigo-600 px-2 py-3 bg-indigo-700 cursor-pointer menu-link" onclick="viewProdLed('ledger')">Ledgers & Groups</a></li><li class="border-t border-gray-500"></li>
        <li><a class="block hover:bg-indigo-600 px-2 py-3 bg-indigo-700 cursor-pointer menu-link" onclick="viewProdLed('product')">Products & Groups</a></li><li class="border-t border-gray-500"></li>
        <li><a class="block hover:bg-lime-600 px-2 py-3 bg-lime-700 cursor-pointer menu-link" onclick="window.logout()">Logout</a></li>
    </ul>
</nav>

<div id="loginContainer" class="hidden w-full max-w-md p-1 mt-[50px] rounded-b-2xl bg-gray-900">
    <input class="input-box mt-10" id="loginEmail" placeholder="Email ....." type="email"><br><br>
    <input class="input-box" id="loginPassword" placeholder="Password ....." type="password"><br><br>
    <button class="block mx-auto mt-10 mb-5 px-5 py-2 bg-green-700 hover:bg-green-600 rounded-lg" onclick="login()">🏠︎ Login</button>
</div>

<div id="ledger" class="hidden w-full max-w-md p-1 rounded-b-2xl bg-gray-900">
    <label class="label">Select Ledger Group ↓↓</label><input class="input-box" id="ledgergroup" type="text" autocomplete="off"/>
    <label class="label">Ledger Name ↓↓</label><input class="input-box" id="ledgername" type="text" autocomplete="off"/>
    <label class="label">Opening Balance ↓↓</label><input class="input-box" id="opbal" type="number" autocomplete="off"/>
    <label class="label">Credit/Debit ↓↓</label><input class="input-box" id="balTypeLed" type="text" autocomplete="off"/>
    <label class="label">Narration ↓↓</label><input class="input-box" id="lnar" type="text" autocomplete="off"/>
    <button class="block mx-auto mt-10 mb-5 px-5 py-2 bg-green-700 hover:bg-green-600 rounded-lg" onclick="saveProdLed('ledger')">👉Save Ledger👈</button>
</div>

<div id="product" class="hidden w-full max-w-md p-1 rounded-b-2xl bg-gray-900">
    <label class="label">Select Product Group ↓↓</label><input class="input-box" id="productgroup" type="text" autocomplete="off"/>
    <label class="label">Product Name ↓↓</label><input class="input-box" id="productname" type="text" autocomplete="off"/>
    <label class="label">Opening Stock ↓↓</label><input class="input-box" id="opstk" type="number"/>
    <label class="label">Narration ↓↓</label><input class="input-box" id="pnar" type="text" autocomplete="off"/>
    <button class="block mx-auto mt-10 mb-5 px-5 py-2 bg-green-700 hover:bg-green-600 rounded-lg" onclick="saveProdLed('product')">👉Save Product👈</button>
</div>

<div id="transaction" class="hidden w-full max-w-md p-1 rounded-b-2xl bg-gray-900">
    <label class="label">Transaction Type ↓↓</label><input class="input-box" id="ttype" type="text" autocomplete="off"/>
    <label class="label">Date ↓↓</label><input class="date-input input-box" id="date" type="text"/>
    <label class="label">From ↓↓</label><input class="input-box" id="txtfrom" type="text" autocomplete="off">
    <label class="label">To ↓↓</label><input class="input-box" id="txtto" type="text" autocomplete="off">
    <label class="label">Amount ↓↓</label><input class="input-box" id="amt" type="number"/>
    <label class="label">Narration ↓↓</label><input class="input-box" id="nar" type="text" autocomplete="off"/>
    <div class="flex items-center gap-1 flex-nowrap">
        <button class="mt-5 mb-5 w-[120px] h-10 bg-green-700 hover:bg-green-600 rounded-lg" onclick="saveTransaction()">👉Save👈</button>
        <input class="w-full mt-5 mb-5 px-2 h-10 bg-gray-900 border border-blue-600 rounded-lg" id="calc" type="text" autocomplete="off" placeholder="🧮 Calculator"/>
    </div>
</div>

<div id="tableCont-profitLoss">
    <div id="tableCont" class="hidden w-full p-1 rounded-b-2xl bg-gray-900">
        <div class="flex items-center gap-1 mb-1 flex-nowrap">
            <button class="bg-green-800 px-2 h-10 rounded-lg" id="excelBtn">𝄜XL</button>
            <button class="bg-red-800 px-2 h-10 rounded-lg" id="pdfBtn">PDF</button>
            <button class="bg-blue-800 px-3 h-10 rounded-lg" id="printBtn">🖨️</button>
            <input class="w-full px-2 h-10 bg-gray-900 border border-blue-600 rounded-lg" id="searchBox" placeholder="Search..." type="text"/>
        </div>
        <div class="overflow-x-auto"><div id="table" class="rounded-lg mx-auto text-[18px] font-[Roboto]"></div></div>
    </div>
    <div id="profitLoss" class="hidden w-full ml-1 rounded-b-2xl bg-gray-900">
        <div class="flex items-center gap-1 flex-nowrap">
            <button class="mb-5 w-[120px] h-10 bg-green-700 hover:bg-green-600 rounded-lg" onclick="profit_loss()">👉View👈</button>
            <input class="w-full mb-5 px-2 h-10 bg-gray-900 border border-blue-600 rounded-lg" id="clostk" type="number" placeholder="Closing Stock"/>
        </div>
    </div>
</div>

<div id="errorBox" class="hidden fixed top-0 left-0 w-full max-w-md bg-gray-900 shadow-lg rounded-lg text-left z-50">
    <h2 class="bg-red-800 text-white font-semibold px-4 py-4 mb-3 rounded-t-lg">⚠️ Information</h2>
    <p id="errorMessage" class="text-left px-4 mt-5 mb-5 bg-gray-900"></p>
    <button onclick="closeDialog()" class="w-full text-white font-semibold py-3 mt-3 bg-orange-600 hover:bg-orange-800 rounded-b-lg">Close</button>
</div>

<div id="dashboard" class="hidden w-full max-w-md ml-1">
    <h2>Dashboard</h2><canvas id="dashboardChart"></canvas>
</div>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script type="module">
    import {initializeApp} 
    from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut,} 
    from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import {getFirestore, collection, getDocs, getDoc, setDoc, deleteDoc, doc, updateDoc, query, where, addDoc, writeBatch, deleteField} 
    from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    const firebaseConfig = {
        apiKey: "AIzaSyDQWZC6iA5zYKvTXsFl9TYLkZCTl5BzfwA",
        authDomain: "accounts-19d08.firebaseapp.com",
        projectId: "accounts-19d08",
        storageBucket: "accounts-19d08.appspot.com",
        messagingSenderId: "247308606105",
        appId: "1:247308606105:web:9bfc179368524244bf3608", };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const tranCol = collection(db, "umesh");
    const groupNames = ["Cash", "Bank", "Creditors", "Debitors", "Angadiya", "Expense", "Sproducts", "Pproducts"];
    window.currentDocId = null;
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            document.getElementById("topbar").classList.remove("hidden");
            await createAndDeduplicateDocuments();
            await loadDropdownData();
            attachDropdown(document.getElementById("ledgergroup"), window.ledgergroup_list);
            attachDropdown(document.getElementById("productgroup"), window.productgroup_list);
            attachDropdown(document.getElementById("ttype"), window.ttype_list);
            attachDropdown(document.getElementById("balTypeLed"), window.baltype_list); } 
        else { 
            document.getElementById("topbar").classList.add("hidden");
            showCont("loginContainer"); } 
    });  
    window.createAndDeduplicateDocuments = async function () {
        for (const groupName of groupNames) {
            const data = { grp: groupName, ttype: "Group" };
            const q = query(tranCol, where("grp", "==", groupName), where("ttype", "==", "Group"));
            const snapshot = await getDocs(q);
            if (snapshot.empty) { await addDoc(tranCol, data); } 
        } 
    };
    document.addEventListener('DOMContentLoaded', () => {
        const labelClass = "mt-3 pl-[10px] text-gray-400 block mb-1";
        document.querySelectorAll('label').forEach(label => {
            label.classList.add(...labelClass.split(' '));
        });
        const inputClass = "w-full px-2 py-2 bg-gray-900 border border-gray-600 rounded-lg focus:outline-none focus:ring-1 focus:ring-yellow-500";
        document.querySelectorAll('.input-box').forEach(input => {
            input.classList.add(...inputClass.split(' '));
            if ((input.tagName === "INPUT" && input.type === "text") || input.tagName === "TEXTAREA") {
                input.addEventListener('input', function () {
                    const start = this.selectionStart;
                    const end = this.selectionEnd;
                    this.value = this.value.toLowerCase().replace(/\b\w/g, char => char.toUpperCase());
                    this.setSelectionRange(start, end); 
                }); 
            } 
        }); 
    });                 
    document.getElementById('topbar').addEventListener('click', () => { 
        document.getElementById('top-nav').classList.remove('-translate-y-full'); 
        showCont("topbar");
    });
    document.querySelectorAll('.menu-link').forEach(link => {
        link.addEventListener('click', e => {
            if (link.getAttribute('id') === 'close') { e.preventDefault(); }
            document.getElementById('top-nav').classList.add('-translate-y-full');
        });
    });
    document.getElementById("calc").addEventListener("keydown", function (e) {
        if (e.key === "Enter") {
            try {
                const raw = this.value.trim();
                if (/^[\d+\-*/().\s]+$/.test(raw)) {
                    const result = Function('"use strict";return (' + raw + ')')();
                    this.value = result; } 
                else { 
                    showDialog("Invalid expression. Only numbers and + - * / allowed. 🤕", "error"); 
                } 
            } 
            catch (error) {
                showDialog("Invalid calculation. 🎲", "error");
            } 
        } 
    });
    flatpickr(".date-input", { dateFormat: "d-m-Y", });
    window.showDialog = function (message, type = "error") {
        document.getElementById('errorMessage').innerHTML = message.replace(/\n/g, '<br>'); 
        const titleEl = document.querySelector('#errorBox h2');
        const closeBtn = document.querySelector('#errorBox button');
        titleEl.classList.remove('bg-red-800', 'bg-green-800');
        closeBtn.classList.remove('bg-orange-600', 'hover:bg-orange-800', 'bg-green-600', 'hover:bg-green-800');
        document.getElementById('errorBox').classList.remove('hidden'); 

        if (type === "success") {
            titleEl.classList.add('bg-green-800');
            titleEl.textContent = "✅ Success";
            closeBtn.classList.add('bg-green-600', 'hover:bg-green-800'); 
        } 
        else {
            titleEl.classList.add('bg-red-800');
            titleEl.textContent = "⚠️ Error";
            closeBtn.classList.add('bg-orange-600', 'hover:bg-orange-800'); 
        } 
    };
    window.closeDialog = async function () { document.getElementById('errorBox').classList.add('hidden'); };
    window.clear = function () {
        document.querySelectorAll("input").forEach(el => el.value = "");
        document.getElementById("ttype").disabled = false;
        loadDropdownData(); 
    };
    window.showCont = function (...idToShow) {
        clear();
        const allIds = ['loginContainer', 'group', 'ledger', 'product', 'transaction', 'tableCont', 'profitLoss', 'dashboard'];
        allIds.forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                el.classList.add("hidden");
                el.style.setProperty('display', 'none', 'important'); 
            } 
        });

        idToShow.forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                el.classList.remove("hidden");
                el.style.setProperty('display', 'block', 'important'); 
            } 
        }); 
    };

    window.loadDropdownData = async function () {
        const snapshot = await getDocs(tranCol);
        const nameSet = new Set();
        const sproductSet = new Set();
        const pproductSet = new Set();
        const crdbSet = new Set();
        const crdbcsbkangSet = new Set();
        const crdbcsbkangexpSet = new Set();

        snapshot.forEach((doc) => {
            const data = doc.data();
            const grp = (data.grp || "").trim();
            const name = (data.name || "").trim();
            if (name.length > 0) {nameSet.add(name);}
            if (grp === "Sproducts" && name.length > 0) {sproductSet.add(name);}
            if (grp === "Pproducts" && name.length > 0) {pproductSet.add(name);}
            if (["Creditors", "Debitors"].includes(grp) && name.length > 0) {crdbSet.add(name);}
            if (["Creditors", "Debitors", "Cash", "Bank", "Angadiya",].includes(grp) && name.length > 0) {crdbcsbkangSet.add(name);}
            if (["Creditors", "Debitors", "Cash", "Bank", "Angadiya", "Expense"].includes(grp) && name.length > 0) {crdbcsbkangexpSet.add(name);} 
        });

        window.names_list = [...nameSet].sort((a, b) => a.localeCompare(b));
        window.sproduct_list = [...sproductSet].sort((a, b) => a.localeCompare(b));
        window.pproduct_list = [...pproductSet].sort((a, b) => a.localeCompare(b));
        window.crdb_list = [...crdbSet].sort((a, b) => a.localeCompare(b));
        window.crdbcsbkang_list = [...crdbcsbkangSet].sort((a, b) => a.localeCompare(b));
        window.crdbcsbkangexp_list = [...crdbcsbkangexpSet].sort((a, b) => a.localeCompare(b)); 
        window.baltype_list = ["Credit", "Debit"]; 
        window.productgroup_list = ["Sproducts", "Pproducts"];
        window.ttype_list = ["Sales", "Purchase", "Receipt", "Payment"];
        window.ledgergroup_list = [ "Angadiya", "Bank", "Cash", "Creditors", "Debitors", "Expense"]; 
    };  
    window.attachDropdown = function (inputElement, dataList) {
        if (inputElement._dropdownCleanup) { inputElement._dropdownCleanup(); }

        let wrapper = inputElement.parentElement;
        if (!wrapper.classList.contains("relative")) {
            wrapper = document.createElement("div");
            wrapper.className = "relative w-full";
            inputElement.parentNode.insertBefore(wrapper, inputElement);
            wrapper.appendChild(inputElement);
        }
        let dropdown = document.createElement("ul");
        dropdown.className = "absolute z-50 w-full max-h-100 overflow-y-auto bg-gray-800 border border-green-600 rounded-md hidden";
        wrapper.appendChild(dropdown);

        function filterList() {
            const search = inputElement.value.toLowerCase();
            const matches = dataList.filter(item => item.toLowerCase().includes(search));
            populateDropdown(matches);
        }
        function populateDropdown(list) {
            dropdown.innerHTML = "";
            list.forEach(item => {
                const li = document.createElement("li");
                li.textContent = item;
                li.className = "px-2 py-2 hover:bg-gray-700 cursor-pointer";
                li.addEventListener('click', () => {
                    inputElement.value = item;
                    dropdown.classList.add("hidden");
                    if (inputElement.id === "ttype") { changeLists(); }
                });
                dropdown.appendChild(li);
            });
        }
        const onInput = () => { dropdown.classList.remove("hidden"); filterList(); };
        const onClick = () => { dropdown.classList.remove("hidden"); filterList(); };
        const onBlur = () => {
            setTimeout(() => {
                const value = inputElement.value.trim().toLowerCase();
                if (value && !dataList.some(item => item.toLowerCase() === value)) {
                    showDialog("Please select a valid option from the list. 🚫", "error");
                    inputElement.value = "";
                    return;
                }
            }, 200);
        };
        const onDocClick = (e) => { if (!wrapper.contains(e.target)) dropdown.classList.add("hidden"); };
        inputElement.addEventListener("input", onInput);
        inputElement.addEventListener("click", onClick);
        inputElement.addEventListener("blur", onBlur);
        document.addEventListener("click", onDocClick);

        inputElement._dropdownCleanup = () => {
            inputElement.removeEventListener("input", onInput);
            inputElement.removeEventListener("click", onClick);
            inputElement.removeEventListener("blur", onBlur);
            document.removeEventListener("click", onDocClick);
            if (dropdown.parentNode) dropdown.parentNode.removeChild(dropdown);
            inputElement._dropdownCleanup = null;
        };
    };

    window.createEditableTable = function (rows, columns, showDelete = true, showUpdate = true, editable = false) {
        if (window.table && typeof window.table.destroy === "function") window.table.destroy();
        const searchId = document.getElementById('searchBox');
        const fullColumns = columns.map(col => ({...col, editor: editable ? col.editor || "input" : false,}));

        if (showDelete) {
            fullColumns.push({
                title: "",
                field: "__delete",
                formatter: () => `<div class="text-center cursor-pointer">⛔</div>`,
                width: 50,
                hozAlign: "center",
                cellClick: async (e, cell) => {
                    e.stopPropagation();
                    const rowData = cell.getRow().getData();
                    const confirmed = confirm("Delete? Are You Sure?");
                    if (confirmed && rowData.id) {
                        await deleteDoc(doc(db, "umesh", rowData.id));
                        cell.getRow().delete(); 
                    } 
                }, 
            }); 
        }

        if (showUpdate) {
            fullColumns.push({
                title: "",
                field: "__update",
                formatter: () => `<div class="text-center cursor-pointer">✏️</div>`,
                width: 50,
                hozAlign: "center",
                cellClick: (e, cell) => {
                    e.stopPropagation();
                    const rowData = cell.getRow().getData();
                    window.currentDocId = rowData.id;
                    showTransactionContainer(rowData); 
                } 
            }); 
        }

        window.table = new Tabulator(document.getElementById('table'), {
            data: rows,
            layout: "fitDataTable",
            reactiveData: true,
            rowHeight: 40,
            maxHeight: "600px",
            columns: fullColumns, 
        });

        document.getElementById('excelBtn')?.addEventListener("click", () => { window.table.download("xlsx", "data.xlsx", {sheetName: "Sheet1"}); });
        document.getElementById('pdfBtn')?.addEventListener("click", () => { window.table.download("pdf", "data.pdf", {orientation: "portrait"}); });
        document.getElementById('printBtn')?.addEventListener("click", () => { window.table.print(false, true); });
        bindSearch(); 
    };
    window.bindSearch = function () {
        const searchbox = document.getElementById("searchBox");
        searchbox.addEventListener("input", function () {
            const value = this.value.toLowerCase().trim();
            table.setFilter(function (data) {
                if (value === "") { return true; }
                return Object.values(data).some(val => String(val).toLowerCase().includes(value)); 
            }); 
        }); 
    };

    window.showTransactionContainer = function (rowData) {
        const type = (rowData.ttype || "").trim();
        document.getElementById("tableCont").classList.add("hidden");
        document.querySelectorAll("input:not(#ttype)").forEach(el => el.value = "");

        switch (type) {
            case "Sales":
            case "Purchase":
            case "Receipt":
            case "Payment":
                showCont('transaction');
                document.getElementById("ttype").value = rowData.ttype || "";
                document.getElementById("date").value = rowData.date || "";
                document.getElementById("txtfrom").value = rowData.fparty || "";
                document.getElementById("txtto").value = rowData.tparty || "";
                document.getElementById("amt").value = rowData.amt || "";
                document.getElementById("nar").value = rowData.nar || "";
                break;
            case "Opening Balance":
                showCont('ledger')
                document.getElementById("ledgergroup").value = rowData.grp || "";
                document.getElementById("ledgername").value = rowData.name || "";  
                document.getElementById("opbal").value = rowData.amt || "";
                document.getElementById("balTypeLed").value = rowData.baltype || "";
                document.getElementById("lnar").value = rowData.nar || "";
                break;
            case "Opening Stock":
                showCont('product')
                document.getElementById("productgroup").value = rowData.grp || "";
                document.getElementById("productname").value = rowData.name || "";  
                document.getElementById("opstk").value = rowData.amt || "";
                document.getElementById("pnar").value = rowData.nar || "";
                break; 
        }
        document.getElementById("ttype").disabled = true;
        changeLists(); 
    };
    window.changeLists = function () {
        const ttype = document.getElementById("ttype").value;
        const txtfrom = document.getElementById("txtfrom");
        const txtto = document.getElementById("txtto");
        
        if (ttype === "Sales") {
            attachDropdown(txtfrom, window.sproduct_list);
            attachDropdown(txtto, window.crdb_list);
        } else if (ttype === "Purchase") {
            attachDropdown(txtfrom, window.crdb_list);
            attachDropdown(txtto, window.pproduct_list);
        } else if (ttype === "Receipt" || ttype === "Payment") {
            attachDropdown(txtfrom, window.crdbcsbkang_list);
            attachDropdown(txtto, window.crdbcsbkangexp_list); 
        }
     };

    window.insertTran = async function (showDelete = true, showUpdate = true, editable = false, filterCashGroup = false) {
        let cashNames = new Set();
        if (filterCashGroup) {
            const partySnapshot = await getDocs(tranCol);
            partySnapshot.forEach((doc) => {
                const data = doc.data();
                if ((data.grp || "").trim() === "Cash") { 
                    cashNames.add((data.name || "").trim()); 
                } 
            }); 
        };

        const snapshot = await getDocs(tranCol);
        const rows = [];
        
        snapshot.forEach((docSnap) => {
            const data = docSnap.data();
            const ttype = (data.ttype || "").trim();
            const date = (data.date || "").trim();

            if (ttype === "Group" || !date) return;
            if (filterCashGroup) { 
                if (!cashNames.has((data.fparty || "").trim()) && !cashNames.has((data.tparty || "").trim())) { 
                    return; 
                } 
            }

            rows.push({
                id: docSnap.id,
                date: date.split('-').reverse().join('-').replace(/(\d{2})-(\d{4})$/, '$1-$2'),
                ttype: ttype,
                fparty: data.fparty || "",
                tparty: data.tparty || "",
                nar: data.nar || "",
                amt: data.amt || "", }); });

        const columns = [
            {title: "Date", field: "date"}, 
            {title: "Type", field: "ttype"}, 
            {title: "From Party", field: "fparty"}, 
            {title: "To Party", field: "tparty"}, 
            {title: "Narration", field: "nar"}, 
            {title: "Amount", field: "amt", hozAlign: "right"}, 
            {title: "ID", field: "id", visible: false} 
        ];

        createEditableTable(rows, columns, showDelete, showUpdate, editable);
        showCont("tableCont"); 
    };
    window.saveTransaction = async function () {
        const ttype = document.getElementById("ttype").value.trim();
        const odate = document.getElementById("date");
        const date = odate._flatpickr.formatDate(odate._flatpickr.parseDate(odate.value.trim(), "d-m-Y"), "Y-m-d");
        const fparty = document.getElementById("txtfrom").value.trim();
        const tparty = document.getElementById("txtto").value.trim();
        const amt = parseFloat(document.getElementById("amt").value.trim()) || 0;
        const nar = document.getElementById("nar").value.trim();
        
        if (!ttype || !date || !fparty || !tparty || isNaN(amt) || amt <= 0) { showDialog("Please fill all required fields properly\nAmount must be a number > 0", "error"); return ; }        
        const tranData = {ttype, date, fparty, tparty, amt, nar};
        if (window.currentDocId) {
            const docRef = doc(db, "umesh", window.currentDocId);
            await updateDoc(docRef, tranData);
            showDialog("Transaction updated successfully. 🛒 ✏️", "success");
            await insertTran();
        } 
        else {
            await addDoc(collection(db, "umesh"), tranData);
            showDialog("Transaction saved successfully. 🛒 💾", "success"); 
        }
        clear(); 
        window.currentDocId = null; 
    };

    window.insertProdLed = async function (type) {
        const snapshot = await getDocs(tranCol);
        const rows = [];

        snapshot.forEach((docSnap) => {
            const data = docSnap.data();
            const ttype = (data.ttype || "").trim();

            if (ttype === type) {
                rows.push({
                    id: docSnap.id,
                    ttype: ttype,
                    amt: data.amt || "",
                    nar: data.nar || "",
                    name: data.name || "",
                    grp: data.grp || "",
                    baltype: data.baltype || "", 
                }); 
            }; 
        });

        const columns = [
            {title: "Group", field: "grp"},
            {title: "Name", field: "name"},
            {title: "Amount", field: "amt", hozAlign: "right"},
            {title: "Narration", field: "nar"},             
        ];
        createEditableTable(rows, columns, false, true, false);
        await showCont("tableCont");
    };
    window.saveProdLed = async function (type) {
        let group, newName, amtValue, nar, balType, amt;
        const isProductGroup = (g) => g === "Sproducts" || g === "Pproducts";

        if (type === "product") {
            group = document.getElementById("productgroup").value.trim();
            newName = document.getElementById("productname").value.trim();
            amtValue = document.getElementById("opstk").value.trim();
            nar = document.getElementById("pnar").value.trim();
            balType = "Credit"; 
        } 
        else if (type === "ledger") {
            group = document.getElementById("ledgergroup").value.trim();
            newName = document.getElementById("ledgername").value.trim();
            amtValue = document.getElementById("opbal").value.trim();
            nar = document.getElementById("lnar").value.trim();
            balType = document.getElementById("balTypeLed").value.trim(); 
        }

        const docId = window.currentDocId;
        if (amtValue !== "" && !isNaN(amtValue)) amt = parseFloat(amtValue);
        if (!group || !newName) { 
            showDialog("Group and Name are required. 👨‍👨‍👦‍👦 🧾", "error"); 
            return; 
        }
        if (amtValue.trim() !== "") { 
            if (balType !== "Credit" && balType !== "Debit") { 
                showDialog("If amount is entered, Balance Type must be Credit or Debit. 💰", "error"); 
                return; 
            } 
        }
        
        let oldName = null;
        if (docId) { 
            const existingDoc = await getDoc(doc(db, "umesh", docId)); oldName = existingDoc.data().name || "";
        }
        if (!docId || (docId && newName !== oldName)) {
            const q = query(tranCol, where("name", "==", newName));
            const snapshot = await getDocs(q);
            if (!snapshot.empty) { 
                showDialog(`A ${type === "product" ? "product" : "ledger"} with this name already exists. 👯‍♀️ 🧾`, "error"); 
                return; 
            }
        }
            
        let ttype = isProductGroup(group) ? "Opening Stock" : "Opening Balance";
        const assignPartyFields = (dataObj) => {
            if (amt !== undefined) { 
                dataObj.amt = amt;
                if (isProductGroup(group)) { 
                    dataObj.fparty = newName; 
                } 
                else if (balType === "Credit") { 
                    dataObj.fparty = newName; 
                } 
                else if (balType === "Debit") { 
                    dataObj.tparty = newName; 
                } 
            } 
        };

        if (docId) {
            const updateObj = { grp: group, name: newName, ttype: ttype };
            if (amt !== undefined) updateObj.amt = amt;
            updateObj.nar = nar ? nar : deleteField();

            if (isProductGroup(group)) { 
                updateObj.fparty = newName; 
            } 
            else if (balType === "Credit") { 
                updateObj.fparty = newName; updateObj.tparty = deleteField(); 
            } 
            else if (balType === "Debit") { 
                updateObj.tparty = newName; updateObj.fparty = deleteField(); 
            } 
            else { 
                updateObj.fparty = deleteField(); updateObj.tparty = deleteField(); 
            }

            const existingDoc = await getDoc(doc(db, "umesh", docId));
            const oldName = existingDoc.data().name || "";
            updateObj.baltype = (balType === "Credit" || balType === "Debit") ? balType : deleteField();
            await updateDoc(doc(db, "umesh", docId), updateObj);

            const querySnapshot = await getDocs(tranCol);
            const batch = writeBatch(db);
            querySnapshot.forEach((docSnap) => {
                const data = docSnap.data();
                const updates = {};
                let shouldUpdate = false;

                if (data.fparty === oldName) { 
                    updates.fparty = (balType === "Credit" || isProductGroup(group)) ? newName : deleteField(); 
                    shouldUpdate = true; 
                }
                if (data.tparty === oldName) { 
                    updates.tparty = (balType === "Debit") ? newName : deleteField(); 
                    shouldUpdate = true; 
                }
                if (shouldUpdate) { 
                    batch.update(doc(db, "umesh", docSnap.id), updates); 
                } 
            });

            await batch.commit();
            showDialog(`${type === "product" ? "Product" : "Ledger"} and linked entries updated successfully. 🧾`, "success");
            insertProdLed(`${type === "product" ? "Opening Stock" : "Opening Balance"}`);
        } 
        else {
            const newDocData = { grp: group, name: newName, ttype: ttype };
            if (nar) newDocData.nar = nar;
            assignPartyFields(newDocData);
            if (balType === "Credit" || balType === "Debit") newDocData.baltype = balType;
            await addDoc(tranCol, newDocData);
            showDialog(`New ${type === "product" ? "product" : "ledger"} saved successfully. 🧾`, "success"); 
        }
        clear();
        window.currentDocId = null; 
    };
    window.viewProdLed = async function (type) {
        const snapshot = await getDocs(tranCol);
        const rows = [];
        snapshot.forEach((docSnap) => {
            const data = docSnap.data();
            const grp = (data.grp || "").trim();
            const name = (data.name || "").trim();

            if (!grp || !name) return;
            if (type === "ledger" && grp !== "Sproducts" && grp !== "Pproducts") { 
                rows.push({ id: docSnap.id, grp: grp, name: name }); 
            } 
            else if (type === "product" && (grp === "Sproducts" || grp === "Pproducts")) { 
                rows.push({ id: docSnap.id, grp: grp, name: name }); 
            } 
        });

        const columns = [ 
            { title: "Group", field: "grp" }, 
            { title: "Name", field: "name" } 
        ];
        createEditableTable(rows, columns, false, false, false);
        showCont("tableCont"); 
    };

    window.viewSummary = async function (mode = "receivables") {
        const snapshot = await getDocs(tranCol);
        const ledgerGroups = {};
        const balances = {};

        snapshot.forEach((doc) => {
            const data = doc.data();
            const name = (data.name || "").trim();
            const grp = (data.grp || "").trim();

            if (name && grp) { ledgerGroups[name] = grp; }
            if (["receivables", "payables"].includes(mode)) {
                if (data.fparty) {
                    const party = data.fparty.trim();
                    balances[party] = (balances[party] || 0) + parseFloat(data.amt || "0"); 
                }
                if (data.tparty) {
                    const party = data.tparty.trim();
                    balances[party] = (balances[party] || 0) - parseFloat(data.amt || "0"); 
                } 
            } 
            else if (["sales", "purchase"].includes(mode)) {
                ["fparty", "tparty"].forEach(key => {
                    if (data[key]) {
                        const party = data[key].trim();
                        balances[party] = (balances[party] || 0) + parseFloat(data.amt || "0"); 
                    } 
                }); 
            } 
        });

        let rows = [], total = 0, firstColTitle = "Party";
        if (["receivables", "payables"].includes(mode)) {
            const isReceivable = mode === "receivables";
            const allowedGroups = ["Creditors", "Debitors", "Bank", "Angadiya", "Cash"];

            for (const [party, amount] of Object.entries(balances)) {
                const grp = ledgerGroups[party];
                if (grp && allowedGroups.includes(grp)) {
                    const isValid = (isReceivable && amount < 0) || (!isReceivable && amount > 0);
                    if (isValid) {
                        const absAmt = Math.abs(amount);
                        rows.push({ party, amount: absAmt.toFixed(0) });
                        total += absAmt; 
                    } 
                } 
            } 
        } 
        else {
            const isSales = mode === "sales";
            const targetGroup = isSales ? "Sproducts" : "Pproducts";
            firstColTitle = "Products";

            Object.entries(balances).forEach(([party, amount]) => {
                const grp = ledgerGroups[party];
                if (amount && grp === targetGroup) {
                    total += Number(amount);
                    rows.push({ party, amount: Number(amount).toFixed(0) });
                } 
            }); 
        }

        rows.sort((a, b) => Number(b.amount) - Number(a.amount));
        rows.unshift({ 
            party: ["sales", "purchases"].includes(mode) 
                ? (mode === "sales" ? "Sales Total" : "Purchase Total") 
                : "Total", 
            amount: total.toFixed(0) 
        });

        const columns = [
            { title: firstColTitle, field: "party" },
            { title: "Amount", field: "amount", hozAlign: "right" } 
        ];
        await createEditableTable(rows, columns, false, false, false);
        showCont("tableCont");
    };

    window.profit_loss = async function () {
        const closingStock = parseFloat(document.getElementById("clostk").value.trim()) || 0;
        const snapshot = await getDocs(tranCol);
        let totalPurchase = 0, totalExpense = 0, totalSales = 0, OpeningStock = 0;
        snapshot.forEach((doc) => {
            const data = doc.data();
            const amount = parseFloat(data.amt || 0);
            const ttype = data.ttype || "";

            if (ttype === "Opening Stock") { OpeningStock += amount; }
            if (ttype === "Purchase") { totalPurchase += amount; } 
            else if (ttype === "Expense") { totalExpense += amount; } 
            else if (ttype === "Sales") { totalSales += amount; } 
        });

        const debitTotal = OpeningStock + totalPurchase + totalExpense;
        const creditTotal = totalSales + closingStock;
        const profit = creditTotal - debitTotal;

        const rows = [
            { Description: "Opening Stock", Amount: OpeningStock.toFixed(0) },
            { Description: "Purchase", Amount: totalPurchase.toFixed(0) },
            { Description: "Expense", Amount: totalExpense.toFixed(0) },
            { Description: "Total (Op+Pur+Exp)", Amount: debitTotal.toFixed(0) },
            { Description: "", Amount: "" },
            { Description: "Sales", Amount: totalSales.toFixed(0) },
            { Description: "Closing Stock", Amount: closingStock.toFixed(0) },
            { Description: "Total (Sales+Clo)", Amount: creditTotal.toFixed(0) },
            { Description: "", Amount: "" },
            { Description: "Profit / Loss", Amount: profit.toFixed(0) }, 
        ];

        const columns = [
            { title: "Description", field: "Description", },
            { title: "Amount", field: "Amount", hozAlign: "right" } 
        ];

        createEditableTable(rows, columns, false, false, false);
        showCont("tableCont", "profitLoss"); 
    };
    
    window.login = async function () {
        const email = document.getElementById("loginEmail").value;
        const password = document.getElementById("loginPassword").value;

        try {
            const userCredential = await signInWithEmailAndPassword(auth, email, password);
            const user = userCredential.user;
            const docRef = doc(db, "users", user.uid);
            const docSnap = await getDoc(docRef);

            if (docSnap.exists() && docSnap.data().approved === true) {
                showDialog("Login successful and approved! 🔓", "success");
                showCont("topbar");
            } 
        } 
        catch (error) { 
            showDialog("Login failed\nEnter registered email/password\nor\nContact Gopalji. 😡", "error"); 
        } 
    };
    window.logout = async function () {
        if (!confirm("Are you sure you want to logout?")) 
        return;

        try {
            clear();
            window.currentDocId = null;
            await signOut(auth);
            showDialog("Logged out successfully. 👋", "success");
            document.getElementById("topbar").classList.add("hidden");
            document.getElementById("topbar").style.setProperty('display', 'none', 'important'); 
            showCont("loginContainer"); 
        } 
        catch (error) { 
            showDialog("Network issue: Failed to logout. Please try again.", "error"); 
        } 
    };
    
    window.showDashboard = async function () {
        showCont("dashboard");
        const querySnapshot = await getDocs(tranCol);
        const monthlyData = {};

        querySnapshot.forEach((docSnap) => {
            const data = docSnap.data();
            let jsDate = new Date(data.date);
            if (isNaN(jsDate)) return;

            const month = jsDate.toLocaleString('default', { month: 'short' });
            if (!monthlyData[month]) {
                 monthlyData[month] = { 
                    sales: 0, purchase: 0, expense: 0 
                }; 
            }

            const ttype = (data.ttype || "").trim().toLowerCase();
            if (ttype === "sales") { monthlyData[month].sales += data.amt || 0; } 
            if (ttype === "purchase") { monthlyData[month].purchase += data.amt || 0; } 
        });

        const monthOrder = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
        const labels = Object.keys(monthlyData).sort((a, b) => monthOrder.indexOf(a) - monthOrder.indexOf(b));
        const sales = labels.map(m => monthlyData[m].sales);
        const purchase = labels.map(m => monthlyData[m].purchase);

        if (window.dashboardChart instanceof Chart) { window.dashboardChart.destroy(); }

        window.dashboardChart = new Chart(document.getElementById("dashboardChart"), {
            type: 'bar',
            data: { labels,
                    datasets: [
                        { label: "Sales", data: sales, backgroundColor: "rgba(75, 192, 192, 0.6)" },
                        { label: "Purchase", data: purchase, backgroundColor: "rgba(255, 159, 64, 0.6)" } 
                    ] 
            }, 
            options: { 
                responsive: true, 
                plugins: { 
                    datalabels: { 
                        anchor: 'end', align: 'start', formatter: value => value.toLocaleString(), 
                        font: { weight: 'bold' }, color: '#fff' 
                    } 
                }, 
                scales: { y: { beginAtZero: true } } 
            }, 
            plugins: [ChartDataLabels] 
        }); 
    };    
    window.addEventListener("beforeunload", function (e) { e.preventDefault(); e.returnValue = "Do u want to close?"; });
</script>
</body>
</html>

